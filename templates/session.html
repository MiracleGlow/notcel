{% extends "layout.html" %}

{% block title %}{{ session_name }}{% endblock %}

{% block content %}
<!-- Session Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('index') }}" class="btn btn-light rounded-circle btn-icon-only me-3 shadow-sm">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div class="lh-1">
            <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Sesi {{ 'Private' if
                session_type == 'private' else 'Publik' }}</div>
            <h1 class="h5 fw-bold mb-0 text-break">{{ session_name }}</h1>
        </div>
    </div>
    <!-- Storage Pie Chart -->
    <div class="storage-pie-wrapper" id="storagePieWrapper" data-used="{{ storage_info.used }}"
        data-limit="{{ storage_info.limit }}" data-used-mb="{{ storage_info.used_mb }}"
        data-limit-mb="{{ storage_info.limit_mb|int }}" data-percentage="{{ storage_info.percentage }}">
        <canvas id="storagePieCanvas" width="38" height="38"></canvas>
        <!-- Floating Storage Popup -->
        <div class="storage-popup" id="storagePopup">
            <div class="storage-popup-title">
                <i class="bi bi-hdd-fill me-1"></i> Penyimpanan Sesi
            </div>
            <div class="storage-popup-chart">
                <canvas id="storagePieCanvasLarge" width="80" height="80"></canvas>
                <div class="storage-popup-percent" id="popupPercent">{{ storage_info.percentage }}%</div>
            </div>
            <div class="storage-popup-details">
                <div class="storage-popup-row">
                    <span class="storage-popup-dot used"></span>
                    <span>Terpakai</span>
                    <strong id="popupUsed">{{ storage_info.used_mb }} MB</strong>
                </div>
                <div class="storage-popup-row">
                    <span class="storage-popup-dot free"></span>
                    <span>Tersisa</span>
                    <strong id="popupFree">{{ (storage_info.limit_mb|int - storage_info.used_mb)|round(2) }} MB</strong>
                </div>
                <div class="storage-popup-divider"></div>
                <div class="storage-popup-row total">
                    <span>Total</span>
                    <strong id="popupTotal">{{ storage_info.limit_mb|int }} MB</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons: Tambah Catatan + Upload File side by side -->
<div class="d-flex gap-2 mb-3">
    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 flex-fill" type="button" data-bs-toggle="collapse"
        data-bs-target="#addNoteCollapse" aria-expanded="false" onclick="closeOther('uploadCollapse')">
        <i class="bi bi-pencil-square me-1"></i> Tambah Catatan
    </button>
    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 flex-fill" type="button" data-bs-toggle="collapse"
        data-bs-target="#uploadCollapse" aria-expanded="false" onclick="closeOther('addNoteCollapse')">
        <i class="bi bi-cloud-upload me-1"></i> Upload File
    </button>
</div>

<!-- Add Note Form (Collapsed) -->
<div class="collapse mb-3" id="addNoteCollapse">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <form method="POST"
                action="{{ url_for('add_note_route', session_type=session_type, session_name=session_name) }}">
                <textarea name="content" class="form-control mb-2" rows="3" placeholder="Tulis catatan baru..."
                    required></textarea>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-sm px-3">
                        <i class="bi bi-save me-1"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Form (Collapsed) -->
<div class="collapse mb-3" id="uploadCollapse">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="input-group">
                    <input type="file" class="form-control bg-white" name="file" id="fileInput" required>
                    <button class="btn btn-primary" type="submit" id="uploadBtn">
                        <i class="bi bi-cloud-upload me-1"></i> Upload
                    </button>
                </div>
                <!-- File size info (shown after selecting file) -->
                <div class="file-size-info d-none mt-2" id="fileSizeInfo">
                    <small class="text-muted">
                        <i class="bi bi-file-earmark me-1"></i>
                        Ukuran: <span id="selectedFileSize">0</span>
                    </small>
                </div>
                <!-- Upload progress -->
                <div class="upload-progress-container d-none mt-2" id="uploadProgressContainer">
                    <div class="upload-progress-track">
                        <div class="upload-progress-fill" id="uploadProgressFill" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="uploadProgressText">Mengupload... 0%</small>
                </div>
                <!-- Error message -->
                <div class="upload-error d-none mt-2" id="uploadError">
                    <div class="alert alert-danger alert-sm mb-0 py-2 px-3 d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="uploadErrorText"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== UNIFIED ITEMS LIST ===================== -->
{% if items %}
<div class="d-flex flex-column gap-2">
    {% for item in items %}
    {% if item.type == 'note' %}
    <!-- ===== NOTE CARD ===== -->
    <div class="card border-0 shadow-sm item-card" id="note-{{ item.id }}">
        <div class="card-body py-3 px-3">
            <!-- View Mode -->
            <div class="note-view" id="note-view-{{ item.id }}">
                <div class="note-content mb-2" style="white-space: pre-wrap; word-break: break-word;">{{ item.content }}
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted"><i class="bi bi-clock me-1"></i>{{ item.created_at|format_waktu }}</small>
                    <div class="item-actions">
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-sm btn-outline-secondary js-copy-note"
                                data-note-id="{{ item.id }}" title="Salin">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary js-edit-note"
                                data-note-id="{{ item.id }}" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST"
                                action="{{ url_for('delete_note_route', session_type=session_type, session_name=session_name, note_id=item.id) }}"
                                class="d-inline" onsubmit="return confirm('Hapus catatan ini?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Hapus">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Edit Mode -->
            <div class="note-edit d-none" id="note-edit-{{ item.id }}">
                <form method="POST"
                    action="{{ url_for('edit_note_route', session_type=session_type, session_name=session_name, note_id=item.id) }}">
                    <textarea name="content" class="form-control mb-2" rows="3">{{ item.content }}</textarea>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary js-cancel-edit"
                            data-note-id="{{ item.id }}">Batal</button>
                        <button type="submit" class="btn btn-sm btn-success px-3">
                            <i class="bi bi-save me-1"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% elif item.type == 'file' %}
    <!-- ===== FILE CARD ===== -->
    <div class="card border-0 shadow-sm overflow-hidden item-card">
        <!-- File Preview -->
        {% if item.kind == 'image' %}
        <div class="bg-light text-center p-2">
            <img src="{{ item.url }}" class="img-fluid rounded" style="max-height: 250px;" alt="{{ item.name }}">
        </div>
        {% elif item.kind == 'video' %}
        <div class="bg-dark text-center">
            <video controls class="w-100" style="max-height: 350px;">
                <source src="{{ item.url }}" {% if item.mimetype %}type="{{ item.mimetype }}" {% endif %}>
            </video>
        </div>
        {% elif item.kind == 'audio' %}
        <div class="p-3 bg-light d-flex justify-content-center">
            <audio controls class="w-100">
                <source src="{{ item.url }}" {% if item.mimetype %}type="{{ item.mimetype }}" {% endif %}>
            </audio>
        </div>
        {% endif %}

        <!-- File Info Bar -->
        <div class="card-body d-flex justify-content-between align-items-center py-2 px-3">
            <div class="d-flex align-items-center overflow-hidden">
                <i class="bi 
                        {% if item.kind == 'image' %}bi-file-image text-success
                        {% elif item.kind == 'video' %}bi-file-play text-danger
                        {% elif item.kind == 'audio' %}bi-file-music text-info
                        {% else %}bi-file-earmark text-secondary{% endif %} 
                        me-2 fs-5"></i>
                <span class="text-truncate small fw-medium" style="max-width: 180px;">{{ item.name }}</span>
            </div>
            <div class="item-actions">
                <div class="d-flex gap-1">
                    <a href="{{ item.url }}" download class="btn btn-sm btn-outline-primary" title="Download">
                        <i class="bi bi-download"></i>
                    </a>
                    <form method="POST"
                        action="{{ url_for('delete_file_route', session_type=session_type, session_name=session_name, file_id=item.id) }}"
                        class="d-inline" onsubmit="return confirm('Hapus file ini?')">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Hapus">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5 bg-light rounded-3 border-dashed">
    <i class="bi bi-folder2-open display-4 text-muted mb-3"></i>
    <p class="text-muted mb-0">Sesi ini masih kosong.</p>
    <p class="text-muted small">Tambahkan catatan atau upload file untuk memulai.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const UPLOAD_URL = "{{ url_for('upload_to_session', session_type=session_type, session_name=session_name) }}";
    const STORAGE_URL = "{{ url_for('session_storage', session_type=session_type, session_name=session_name) }}";
    const MAX_SESSION_STORAGE = {{ storage_info.limit }};

    function closeOther(id) {
        const el = document.getElementById(id);
        if (el && el.classList.contains('show')) {
            bootstrap.Collapse.getOrCreateInstance(el).hide();
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getStorageColor(pct) {
        if (pct >= 90) return { main: '#ef4444', gradient: ['#ef4444', '#f87171'], bg: '#fee2e2' };
        if (pct >= 70) return { main: '#f59e0b', gradient: ['#f59e0b', '#fbbf24'], bg: '#fef3c7' };
        return { main: '#22c55e', gradient: ['#22c55e', '#34d399'], bg: '#dcfce7' };
    }

    function drawPie(canvas, percentage, size, lineWidth) {
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        canvas.width = size * dpr;
        canvas.height = size * dpr;
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
        ctx.scale(dpr, dpr);

        const cx = size / 2, cy = size / 2, radius = (size / 2) - lineWidth;
        const colors = getStorageColor(percentage);
        const startAngle = -Math.PI / 2;
        const endAngle = startAngle + (2 * Math.PI * (percentage / 100));

        ctx.clearRect(0, 0, size, size);

        // Background circle
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = '#e9ecef';
        ctx.lineWidth = lineWidth;
        ctx.stroke();

        // Filled arc
        if (percentage > 0) {
            ctx.beginPath();
            ctx.arc(cx, cy, radius, startAngle, endAngle);
            ctx.strokeStyle = colors.main;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();
        }
    }

    function drawAllPies(pct) {
        drawPie(document.getElementById('storagePieCanvas'), pct, 38, 4);
        const largeCanvas = document.getElementById('storagePieCanvasLarge');
        if (largeCanvas) drawPie(largeCanvas, pct, 80, 6);
    }

    function updateStoragePie(data) {
        const wrapper = document.getElementById('storagePieWrapper');
        if (!wrapper) return;
        wrapper.dataset.percentage = data.percentage;
        wrapper.dataset.usedMb = data.used_mb;
        wrapper.dataset.limitMb = parseInt(data.limit_mb);

        drawAllPies(data.percentage);

        // Update popup texts
        const popupPercent = document.getElementById('popupPercent');
        const popupUsed = document.getElementById('popupUsed');
        const popupFree = document.getElementById('popupFree');
        const popupTotal = document.getElementById('popupTotal');
        if (popupPercent) popupPercent.textContent = data.percentage + '%';
        if (popupUsed) popupUsed.textContent = data.used_mb + ' MB';
        if (popupFree) popupFree.textContent = (parseInt(data.limit_mb) - data.used_mb).toFixed(2) + ' MB';
        if (popupTotal) popupTotal.textContent = parseInt(data.limit_mb) + ' MB';

        // Update color of percent text
        const colors = getStorageColor(data.percentage);
        if (popupPercent) popupPercent.style.color = colors.main;
    }

    function refreshStorage() {
        fetch(STORAGE_URL)
            .then(r => r.json())
            .then(data => updateStoragePie(data))
            .catch(() => { });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- Item Card: click to toggle action buttons ---
        document.querySelectorAll('.item-card').forEach(card => {
            card.addEventListener('click', (e) => {
                // Don't toggle if clicking on interactive elements inside actions
                const target = e.target.closest('button, a, form, input, textarea, video, audio');
                if (target) return;

                const isActive = card.classList.contains('active');

                // Close all other active cards
                document.querySelectorAll('.item-card.active').forEach(c => {
                    if (c !== card) c.classList.remove('active');
                });

                // Toggle this card
                card.classList.toggle('active');
            });
        });

        // Close active cards when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.item-card')) {
                document.querySelectorAll('.item-card.active').forEach(c => c.classList.remove('active'));
            }
        });

        // --- File Input: show selected file size ---
        const fileInput = document.getElementById('fileInput');
        const fileSizeInfo = document.getElementById('fileSizeInfo');
        const selectedFileSize = document.getElementById('selectedFileSize');

        fileInput.addEventListener('change', () => {
            const uploadError = document.getElementById('uploadError');
            uploadError.classList.add('d-none');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                selectedFileSize.textContent = formatBytes(file.size);
                fileSizeInfo.classList.remove('d-none');

                // Client-side validation
                if (file.size > MAX_SESSION_STORAGE) {
                    showUploadError('File terlalu besar! Maksimal ' + (MAX_SESSION_STORAGE / (1024 * 1024)) + 'MB.');
                }
            } else {
                fileSizeInfo.classList.add('d-none');
            }
        });

        // --- AJAX Upload ---
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('uploadProgressContainer');
        const progressFill = document.getElementById('uploadProgressFill');
        const progressText = document.getElementById('uploadProgressText');

        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!fileInput.files.length) return;

            const file = fileInput.files[0];

            // Client-side validation
            if (file.size > MAX_SESSION_STORAGE) {
                showUploadError('File terlalu besar! Maksimal ' + (MAX_SESSION_STORAGE / (1024 * 1024)) + 'MB.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();

            // Show progress
            uploadBtn.disabled = true;
            fileInput.disabled = true;
            progressContainer.classList.remove('d-none');
            document.getElementById('uploadError').classList.add('d-none');

            xhr.upload.addEventListener('progress', (evt) => {
                if (evt.lengthComputable) {
                    const pct = Math.round((evt.loaded / evt.total) * 100);
                    progressFill.style.width = pct + '%';
                    progressText.textContent = 'Mengupload... ' + pct + '%';
                }
            });

            xhr.addEventListener('load', () => {
                uploadBtn.disabled = false;
                fileInput.disabled = false;

                if (xhr.status === 200) {
                    // Upload success â€” reload page to show new file
                    progressText.textContent = 'Upload selesai! Memuat ulang...';
                    progressFill.style.width = '100%';
                    window.location.reload();
                } else {
                    progressContainer.classList.add('d-none');
                    try {
                        const resp = JSON.parse(xhr.responseText);
                        showUploadError(resp.error || 'Upload gagal.');
                    } catch {
                        showUploadError('Upload gagal. Status: ' + xhr.status);
                    }
                    // Refresh storage bar in case it changed
                    refreshStorage();
                }
            });

            xhr.addEventListener('error', () => {
                uploadBtn.disabled = false;
                fileInput.disabled = false;
                progressContainer.classList.add('d-none');
                showUploadError('Koneksi gagal. Coba lagi.');
            });

            xhr.open('POST', UPLOAD_URL);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        });

        function showUploadError(msg) {
            const el = document.getElementById('uploadError');
            document.getElementById('uploadErrorText').textContent = msg;
            el.classList.remove('d-none');
        }

        // --- Initialize Pie Chart ---
        const pieWrapper = document.getElementById('storagePieWrapper');
        if (pieWrapper) {
            const pct = parseFloat(pieWrapper.dataset.percentage);
            drawAllPies(pct);

            // Set initial popup percent color
            const popupPercent = document.getElementById('popupPercent');
            if (popupPercent) {
                popupPercent.style.color = getStorageColor(pct).main;
            }

            // Draw large pie when popup becomes visible
            const popup = document.getElementById('storagePopup');

            // Prevent clicks inside popup from toggling it off
            popup.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Toggle pinned state via click on pie (not popup)
            pieWrapper.addEventListener('click', (e) => {
                e.stopPropagation();
                popup.classList.toggle('active');
                if (popup.classList.contains('active')) {
                    drawPie(document.getElementById('storagePieCanvasLarge'), pct, 80, 6);
                }
            });

            // Close pinned popup when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.storage-pie-wrapper')) {
                    popup.classList.remove('active');
                }
            });
        }

        // --- Refresh storage after file delete ---
        document.querySelectorAll('form[action*="/delete"]').forEach(form => {
            const origSubmit = form.onsubmit;
            form.addEventListener('submit', () => {
                // After a short delay, refresh storage
                setTimeout(refreshStorage, 1500);
            });
        });

        // Copy Note
        document.querySelectorAll('.js-copy-note').forEach(btn => {
            btn.addEventListener('click', () => {
                const noteId = btn.dataset.noteId;
                const noteEl = document.querySelector(`#note-view-${noteId} .note-content`);
                if (noteEl && navigator.clipboard) {
                    navigator.clipboard.writeText(noteEl.textContent.trim()).then(() => {
                        const icon = btn.querySelector('i');
                        icon.className = 'bi bi-check-lg';
                        btn.classList.replace('btn-outline-secondary', 'btn-success');
                        setTimeout(() => {
                            icon.className = 'bi bi-clipboard';
                            btn.classList.replace('btn-success', 'btn-outline-secondary');
                        }, 1500);
                    });
                }
            });
        });

        // Edit Note
        document.querySelectorAll('.js-edit-note').forEach(btn => {
            btn.addEventListener('click', () => {
                const noteId = btn.dataset.noteId;
                document.getElementById(`note-view-${noteId}`).classList.add('d-none');
                document.getElementById(`note-edit-${noteId}`).classList.remove('d-none');
            });
        });

        // Cancel Edit
        document.querySelectorAll('.js-cancel-edit').forEach(btn => {
            btn.addEventListener('click', () => {
                const noteId = btn.dataset.noteId;
                document.getElementById(`note-view-${noteId}`).classList.remove('d-none');
                document.getElementById(`note-edit-${noteId}`).classList.add('d-none');
            });
        });
    });
</script>
{% endblock %}