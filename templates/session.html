{% extends "layout.html" %}

{% block title %}Sesi: {{ session_name }} - Nocel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="h3 mb-0 text-break">
            Sesi {{ 'Private' if session_type == 'private' else 'Publik' }}: 
            <span class="fw-bold">{{ session_name }}</span>
        </h1>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Tambah File ke Sesi</h5>
        <form method="POST" action="{{ url_for('upload_to_session', session_type=session_type, session_name=session_name) }}" enctype="multipart/form-data">
            <div class="input-group">
                <input type="file" class="form-control" name="file" required>
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-upload me-1"></i> Upload
                </button>
            </div>
            <div class="form-text mt-2">Ukuran file maksimal yang disarankan adalah 4 MB.</div>
        </form>
    </div>
</div>

{% if files %}
  <div class="list-group">
    {% for f in files %}
      <div class="list-group-item p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <strong class="text-break">{{ f.name }}</strong>
          <a class="btn btn-sm btn-outline-secondary" href="{{ f.url }}" download>
            <i class="bi bi-download me-1"></i> Download
          </a>
        </div>
        <div class="file-preview-wrapper">
            {% if f.kind == 'image' %}
              <img src="{{ f.url }}" class="img-fluid" alt="{{ f.name }}">
            {% elif f.kind == 'video' %}
              <video controls class="w-100"><source src="{{ f.url }}" {% if f.mimetype %}type="{{ f.mimetype }}"{% endif %}></video>
            {% elif f.kind == 'audio' %}
              <audio controls class="w-100"><source src="{{ f.url }}" {% if f.mimetype %}type="{{ f.mimetype }}"{% endif %}></audio>
            
            {% elif f.kind == 'text' %}
              {% set textarea_id = "textarea-" + loop.index|string %}
              <form method="POST" action="{{ url_for('save_text_file', session_type=session_type, session_name=session_name, filename=f.name) }}">
                <div class="mb-2">
                    <textarea name="content" id="{{ textarea_id }}" class="form-control" rows="15">{{ f.text }}</textarea>
                </div>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-sm btn-success btn-icon-only" title="Simpan Perubahan">
                        <i class="bi bi-save"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-icon-only js-copy-btn" title="Salin ke Clipboard" data-target-id="{{ textarea_id }}">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
              </form>
            
            {% else %}
              <p class="text-muted mb-0 fst-italic">Pratinjau tidak tersedia untuk format file ini.</p>
            {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
    <div class="text-center p-5 border rounded">
        <p class="text-muted fs-5">Belum ada file di sesi ini.</p>
        <p>Gunakan form di atas untuk mulai mengunggah.</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('.js-copy-btn');
    copyButtons.forEach(button => {
        button.addEventListener('click', (event) => {
            const targetId = event.currentTarget.dataset.targetId;
            const textarea = document.getElementById(targetId);
            if (textarea && navigator.clipboard) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check-lg"></i>';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-outline-secondary');
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-secondary');
                    }, 2000);
                });
            }
        });
    });
});
</script>
{% endblock %}